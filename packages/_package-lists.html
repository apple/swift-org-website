<nav class="package-categories">
  <label for="category-select">Browse a selection of packages:</label>
  <select id="category-select">
    {%- for category in site.data.packages.packages.categories %}
    <option value="{{ category.slug }}">{{ category.name }}</option>
    {%- endfor %}
  </select>

  <ul class="category-menu">
    <li>Browse a selection of packages:</li>
    {%- for category in site.data.packages.packages.categories %}
    <li><a href="#" data-category-slug="{{ category.slug }}"> {{ category.name }} </a></li>
    {%- endfor %}
  </ul>
</nav>

{%- for category in site.data.packages.packages.categories %}
<section class="package-list" data-category-slug="{{ category.slug }}" data-category-name="{{ category.name }}">
  <h3 id="{{ category.slug }}-packages">{{ category.name }}</h3>
  {{ category.description | markdownify }}
  <ul>
    {% for package in category.packages %}
    <li class="{% if package.note %}with-note{% endif %}">
      <a href="{{ package.url }}" target="_blank">
        <h4>
          <div class="name">{{ package.name }}</div>
          <div class="owner">by {{ package.owner }}</div>
        </h4>
        <section class="description">{{ package.description | markdownify }}</section>
        <section class="metadata">
          {% if package.platform_compatibility %}
          <div class="lozenge platform-compatibility" title="{{ package.platform_compatibility_tooltip }}">
            {% for platform in package.platform_compatibility %}
            <span>{{ platform }}</span>
            {% endfor %}
          </div>
          {% endif %} {% if package.swift_compatibility %}
          <div class="lozenge swift-compatibility" title="Swift version compatibility">
            <span>{{ package.swift_compatibility }}</span>
          </div>
          {% endif %}
          <div class="lozenge license" title="Package license"><span>{{ package.license }}</span></div>
        </section>
      </a>
      {% if package.note %}
      <section class="note">{{ package.note | markdownify }}</section>
      {% endif %}
    </li>
    {%- endfor %}
  </ul>

  {% if category.more %}
  <a class="cta-secondary" href="{{ category.more.url }}" target="_blank">{{ category.more.title }} &rsaquo;</a>
  {% endif %}
</section>
{% endfor %}

<script>
  document.addEventListener("DOMContentLoaded", (event) => {
    const categorySelectElement = document.getElementById("category-select")

    // Set the first category as initially selected, or whatever was incoming as an anchor
    const incomingAnchor = window.location.hash
    if (incomingAnchor.length > 1) {
      const slug = incomingAnchor.substr(1)
      setSelectedPackageList(slug, false)
    } else {
      const firstCategoryOption = categorySelectElement.querySelector("option:first-child")
      setSelectedPackageList(firstCategoryOption.value, false)
    }

    // Switch selected categories whenever a new one is chosen
    categorySelectElement.addEventListener("change", (event) => {
      setSelectedPackageList(categorySelectElement.value)
    })

    // Hook up the change events on the desktop menu
    const menuLinkElements = document.querySelectorAll(".category-menu a[data-category-slug]")
    menuLinkElements.forEach((menuLinkElement) => {
      menuLinkElement.addEventListener("click", (event) => {
        event.preventDefault()
        categorySelectElement.value = event.target.dataset.categorySlug
        categorySelectElement.dispatchEvent(new Event("change"))
      })
    })
  })

  function setSelectedPackageList(slug, insertIntoHistory = true) {
    // Show only the selected package list
    const packageListElements = document.querySelectorAll("section.package-list")
    packageListElements.forEach((packageListElement) => {
      const hiddenCssClass = "hidden"
      packageListElement.classList.add(hiddenCssClass)
      if (packageListElement.dataset.categorySlug === slug) {
        packageListElement.classList.remove(hiddenCssClass)
      }
    })

    // Highlight the selected menu item on desktop
    const menuLinkElements = document.querySelectorAll(".category-menu a[data-category-slug]")
    menuLinkElements.forEach((menuLinkElement) => {
      const activeCssClass = "active"
      menuLinkElement.classList.remove(activeCssClass)
      if (menuLinkElement.dataset.categorySlug === slug) {
        menuLinkElement.classList.add(activeCssClass)
      }
    })

    // Add the slug to the URL as an anchor
    if (insertIntoHistory) {
      history.pushState({}, "", `#${slug}`)
    }
  }
</script>
