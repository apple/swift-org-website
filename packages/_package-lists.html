<div>
  <label for="package-category-select">Category:</label>
  <select id="package-category-select">
    {%- for category in site.data.packages.packages.categories %}
    <option value="{{ category.slug }}">{{ category.name }}</option>
    {%- endfor %}
  </select>
</div>

{%- for category in site.data.packages.packages.categories %}
<section class="package-list" data-category-slug="{{ category.slug }}" data-category-name="{{ category.name }}">
  <h3 id="{{ category.slug }}-packages">{{ category.name }}</h3>
  {{ category.description | markdownify }}
  <ul>
    {% for package in category.packages %}
    <li class="{% if package.note %}with-note{% endif %}">
      <a href="{{ package.url }}" target="_blank">
        <h4>
          <div class="name">{{ package.name }}</div>
          <div class="owner">by {{ package.owner }}</div>
        </h4>
        <section class="description">{{ package.description | markdownify }}</section>
        <section class="metadata">
          {% if package.platform_compatibility %}
          <div class="lozenge platform-compatibility" title="{{ package.platform_compatibility_tooltip }}">
            {% for platform in package.platform_compatibility %}
            <span>{{ platform }}</span>
            {% endfor %}
          </div>
          {% endif %} {% if package.swift_compatibility %}
          <div class="lozenge swift-compatibility" title="Swift version compatibility">
            <span>{{ package.swift_compatibility }}</span>
          </div>
          {% endif %}
          <div class="lozenge license" title="Package license"><span>{{ package.license }}</span></div>
        </section>
      </a>
      {% if package.note %}
      <section class="note">{{ package.note | markdownify }}</section>
      {% endif %}
    </li>
    {%- endfor %}
  </ul>

  {% if category.more %}
  <a class="cta-secondary" href="{{ category.more.url }}" target="_blank">{{ category.more.title }} &rsaquo;</a>
  {% endif %}
</section>
{% endfor %}

<script>
  document.addEventListener("DOMContentLoaded", (event) => {
    const categorySelect = document.getElementById("package-category-select")

    // Set the first category as initially selected
    const firstCategoryOption = categorySelect.querySelector("option:first-child")
    setSelectedPackageList(firstCategoryOption.value)

    // Switch selected categories whenever a new one is chosen
    categorySelect.addEventListener("change", (event) => {
      setSelectedPackageList(categorySelect.value)
    })

    // Create a list that mapipulates the `select`, for use on Desktop browsers only
    const listElement = document.createElement("ul")
    listElement.setAttribute("aria-hidden", "true")
    listElement.classList.add("category-select")
    categorySelect.parentElement.appendChild(listElement)

    const packageListElements = document.querySelectorAll("section.package-list")
    packageListElements.forEach((packageListElement) => {
      const listItemElement = document.createElement("li")
      listElement.appendChild(listItemElement)

      const linkElement = document.createElement("a")
      console.log(packageListElement)
      linkElement.href = "#"
      linkElement.dataset.categorySlug = packageListElement.dataset.categorySlug
      linkElement.innerText = packageListElement.dataset.categoryName
      linkElement.addEventListener("click", (event) => {
        event.preventDefault()
        categorySelect.value = event.target.dataset.categorySlug
        categorySelect.dispatchEvent(new Event("change"))
      })
      listItemElement.appendChild(linkElement)
    })
  })

  function setSelectedPackageList(slug) {
    const packageListElements = document.querySelectorAll("section.package-list")
    packageListElements.forEach((packageListElement) => {
      const hiddenCssClass = "hidden"
      packageListElement.classList.add(hiddenCssClass)
      if (packageListElement.dataset.categorySlug === slug) {
        packageListElement.classList.remove(hiddenCssClass)
      }
    })
  }
</script>
